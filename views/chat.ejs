<!doctype html>
<html>
<head>
	<title>Socket.IO chat</title>
	<link rel='stylesheet' href='/stylesheets/style.css'/>
	<script src="/javascripts/socket.io.js"></script>
	<script src="http://code.jquery.com/jquery-1.11.1.js"></script>
	<script>
		var socket = io.connect('http://localhost:1234/chat');

		var TYPING_TIMER_LENGTH = 400; // ms
		var typing = false;
		var lastTypingTime;

		$(document).ready(function() {
			var $inputMessage = $('#m');

			$('form').submit(function(){
				var /*input = $('#m'),*/
					message = $inputMessage.val();

				socket.emit('chat message', {
					message: message,
					username: 'Tarabass'
				});
				$inputMessage.val('');

				return false;
			});

			$inputMessage.on('input', function() {
				updateTyping();
			});

			// Updates the typing event
			function updateTyping () {
				//if (connected) {
					if (!typing) {
						typing = true;
						socket.emit('typing');
					}

					lastTypingTime = (new Date()).getTime();

					setTimeout(function () {
						var typingTimer = (new Date()).getTime();
						var timeDiff = typingTimer - lastTypingTime;

						if (timeDiff >= TYPING_TIMER_LENGTH && typing) {
							socket.emit('stop typing');
							typing = false;
						}
					}, TYPING_TIMER_LENGTH);
				//}
			}

			socket.on('chat message', function(data){
				$('#messages').append($('<li>').text(data.username + ': ' + data.message));
			});

			// Whenever the server emits 'typing', show the typing message
			socket.on('typing', function (data) {
				$('#typingmessage').fadeIn(function() {
					$(this).text(data.username + ' is typing...')
				});
			});

			// Whenever the server emits 'stop typing', kill the typing message
			socket.on('stop typing', function (data) {
				$('#typingmessage').fadeOut();
			});

			socket.on('connect', function () {
				socket.emit('chat message', {
					message: 'User joined the room!',
					username: 'Tarabass'
				});
			});
		});
	</script>
</head>
<body>
	<div id="typingmessage"></div>
	<h1><%= title %></h1>
	<ul id="messages"></ul>
	<form action="">
		<input id="m" autocomplete="off" /><button>Send</button>
	</form>
</body>
</html>